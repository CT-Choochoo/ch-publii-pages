<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RabbitMQ_API - As One Wants</title><meta name="description" content="RabbitMQ简介 //&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#2A2C33" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#2A2C33"><meta name="apple-mobile-web-app-status-bar-style" content="#2A2C33"><script async defer="defer" type="text/javascript" src="" data-website-id="74fc0332-4948-4dfe-9825-7ef3229acbce" data-auto-track="true" data-do-not-track="true" data-cache="false"></script><link rel="canonical" href="https://ct-choochoo.github.io/ch-publii-pages/rabbitmq-erjian-dan-ren-shi-rabbitmq/"><link rel="alternate" type="application/atom+xml" href="https://ct-choochoo.github.io/ch-publii-pages/feed.xml"><link rel="alternate" type="application/json" href="https://ct-choochoo.github.io/ch-publii-pages/feed.json"><meta property="og:title" content="RabbitMQ_API - As One Wants "><meta property="og:site_name" content="As One Wants"><meta property="og:description" content="RabbitMQ简介 //&hellip;"><meta property="og:url" content="https://ct-choochoo.github.io/ch-publii-pages/rabbitmq-erjian-dan-ren-shi-rabbitmq/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://ct-choochoo.github.io/ch-publii-pages/media/website/Calm.svg" type="image/x-icon"><link rel="preload" href="https://ct-choochoo.github.io/ch-publii-pages/assets/dynamic/fonts/jetbrainsmono/jetbrainsmono.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://ct-choochoo.github.io/ch-publii-pages/assets/dynamic/fonts/redhatmono/redhatmono.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://ct-choochoo.github.io/ch-publii-pages/assets/css/style.css?v=8584c3e928bc7262ae41ef6776c1aa42"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ct-choochoo.github.io/ch-publii-pages/rabbitmq-erjian-dan-ren-shi-rabbitmq/"},"headline":"RabbitMQ_API","datePublished":"2023-03-11T18:09","dateModified":"2023-03-14T09:54","description":"RabbitMQ简介 //&hellip;","author":{"@type":"Person","name":"铁柱","url":"https://ct-choochoo.github.io/ch-publii-pages/authors/tiezhu/"},"publisher":{"@type":"Organization","name":"铁柱"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async defer="defer" src="https://analytics.umami.is/script.js" data-website-id="74fc0332-4948-4dfe-9825-7ef3229acbce"></script><link rel="stylesheet" href="https://ct-choochoo.github.io/ch-publii-pages/media/plugins/docSearch/docsearch.min.css"></head><body><div class="container js-container"><nav class="menu"><ul class="navbar__menu"><li><a href="https://ct-choochoo.github.io/ch-publii-pages/" target="_self">home</a></li><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/" target="_self">标签</a></li><li class="has-submenu"><span>工作</span><ul class="navbar__submenu"><li class="has-submenu"><span>语言</span><ul class="navbar__submenu"><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/biao-qian/" target="_self">java</a></li><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/python/" target="_self">python</a></li></ul></li><li class="has-submenu"><span>框架</span><ul class="navbar__submenu"><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/springboot/" target="_self">springboot</a></li></ul></li><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/common/" target="_self">工具</a></li></ul></li><li class="has-submenu"><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/sheng-huo/" target="_self">生活</a><ul class="navbar__submenu"><li><a href="https://ct-choochoo.github.io/ch-publii-pages/tags/lu-you/" target="_self">游记</a></li></ul></li></ul></nav><div class="content"><header class="top"><div class="top__item"><a class="logo" href="https://ct-choochoo.github.io/ch-publii-pages/">As One Wants</a></div><div class="top__item top__item--right"><button class="menu-toggle js-menu-toggle" aria-label="Menu" aria-expanded="false"><span class="menu-toggle-box"><span class="menu-toggle-inner">Menu</span></span></button></div></header><main class="main"><article class="post"><div class="main__left"><header><h1>RabbitMQ_API</h1><p><time datetime="2023-03-11T18:09">三月 11, 2023 </time>by <a href="https://ct-choochoo.github.io/ch-publii-pages/authors/tiezhu/" rel="author" title="铁柱">铁柱</a></p></header></div><div class="main__right"><div class="post__entry"><p></p><figure class="post__image"><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2022/png/118351/1648181230467-9fdbcd9a-b2a6-46ad-a6dd-623026a089f3.png#crop=0&crop=0&crop=1&crop=1&id=gFtFx&originHeight=1220&originWidth=2079&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="" data-is-external-image="true"></figure><p></p><p><a href="https://ct-choochoo.github.io/ch-publii-pages/rabbitmq-yichu-bu-ren-shi/">RabbitMQ简介</a></p><h2 id="1-需求分析与架构设计">1. 需求分析与架构设计</h2><h3 id="11-项目设计要点">1.1 项目设计要点</h3><ul><li>用微服务系统，组件之间充分解耦</li><li>使用消息中间件，解耦业务逻辑</li><li>使用数据库，持久化业务数据</li></ul><h3 id="12-什么是微服务架构">1.2 什么是微服务架构</h3><ul><li>将应用程序构建为松耦合、可独立部署的一组服务</li><li>服务：一个单一的、可独立部署的软件组件，实现了一些有用的功能</li><li>松耦合：封装服务的实现细节，通过API调用</li></ul><h3 id="13-如何拆分微服务">1.3 如何拆分微服务</h3><ul><li>根据系统操作进行微服务拆分</li><li>根据业务能力进行微服务拆分 （推荐）</li><li>根据子域进行微服务拆分</li></ul><h3 id="14-根据业务能力拆分">1.4 根据业务能力拆分</h3><ul><li>订单获取和履行 → 订单微服务</li><li>供应商和产品管理 → 商家微服务</li><li>送餐，骑手管理 → 骑手微服务</li><li>记账与结算 → 结算微服务</li><li>积分管理 → 积分微服务</li></ul><h3 id="15微服务的数据库设计原则">1.5微服务的数据库设计原则</h3><ul><li>每个微服务使用自己的数据库</li><li>不要使用共享数据库的方式进行通信</li><li>不要使用外键，对于数据量非常少的表慎用索引</li></ul><h2 id="2如何配置rabbitmq">2.如何配置RabbitMQ</h2><h3 id="21-新建exchange">2.1 新建Exchange</h3><pre><code class="language-java">//    exchangeDeclare(交换机名称，路由类型（dirct，fanout，topic），是否持久化，是否自动删除，其他参数)   
channel.exchangeDeclare(
          exchangeName, 
          BuiltinExchangeType.FANOUT, 
          true, 
          false, 
          null);
</code></pre><h3 id="22-新建queue">2.2 新建Queue</h3><pre><code class="language-java">import com.rabbitmq.client.Channel;
//   queueDeclare(队列名称，是否持久化，是否独占队列，是否自动删除，其他参数)
channel.queueDeclare(
          queueName, 
          true, 
          false, 
          false, 
          null);
</code></pre><h3 id="23-绑定exchange和queue">2.3 绑定Exchange和Queue</h3><pre><code class="language-java">import com.rabbitmq.client.Channel;
//   queueBind（队列名称，路由器名称，路由键）    
channel.queueBind(
          queueName, 
          exchangeName, 
          routingKey);
</code></pre><h2 id="3生产者如何发送消息">3.生产者如何发送消息</h2><h3 id="31-新建connectionfactory">3.1 新建ConnectionFactory</h3><pre><code class="language-java">import com.rabbitmq.client.ConnectionFactory;

        CachingConnectionFactory connectionFactory = new CachingConnectionFactory();
//  设置rabbitMQ host
    connectionFactory.setHost(&quot;127.0.0.1&quot;);
//	设置端口
    connectionFactory.setPort(5672);
//	设置用户名，密码
    connectionFactory.setPassword(&quot;admin&quot;);
    connectionFactory.setUsername(&quot;admin&quot;);
</code></pre><h3 id="32-获取connection并创建channel">3.2 获取Connection并创建channel</h3><pre><code class="language-java">import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

//jdk7 加入 try—resource  使用完自动关闭连接
try (Connection connection = connectionFactory.newConnection();
 Channel channel = connection.createChannel()) {
//业务逻辑
}
</code></pre><h3 id="33-使用basicpublish发送消息">3.3 使用basicPublish发送消息</h3><pre><code class="language-java">import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
// basicPublish（路由名称，路由键，其他参数，消息体（byte[]））
channel.basicPublish(
              &quot;exchange.settlement.order&quot;, &quot;key.order&quot;, null, messageToSend.getBytes());
</code></pre><h2 id="4消费者如何消费消息">4.消费者如何消费消息</h2><h3 id="41-配置线程池">4.1 配置线程池</h3><p><strong>当项目中使用到异步时，哪怕是知道是有限线程也最好使用线程池去调度！</strong></p><pre><code class="language-java">package com.boo.rabbitmq.settlement.config;

import java.util.concurrent.Executor;
import org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.AsyncConfigurer;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

/**
 * 异步任务配置
 *
 * @author gaobo
 * @date 2022/03/18
 */
@Configuration
@EnableAsync
public class AsyncTaskConfig implements AsyncConfigurer {

  // ThreadPoolTaskExecutor的处理流程
  // 当池子大小小于corePoolSize，就新建线程，并处理请求
  // 当池子大小等于corePoolSize，把请求放入workQueue中，池子里的空闲线程就去workQueue中取任务并处理
  // 当workQueue放不下任务时，就新建线程入池，并处理请求，如果池子大小撑到了maximumPoolSize，就用RejectedExecutionHandler来做拒绝处理
  // 当池子的线程数大于corePoolSize时，多余的线程会等待keepAliveTime长时间，如果无请求可处理就自行销毁

  @Override
  @Bean
  public Executor getAsyncExecutor() {
    ThreadPoolTaskExecutor threadPool = new ThreadPoolTaskExecutor();
    // 设置核心线程数
    threadPool.setCorePoolSize(10);
    // 设置最大线程数
    threadPool.setMaxPoolSize(100);
    // 线程池所使用的缓冲队列
    threadPool.setQueueCapacity(10);
    // 等待任务在关机时完成--表明等待所有线程执行完
    threadPool.setWaitForTasksToCompleteOnShutdown(true);
    // 等待时间 （默认为0，此时立即停止），并没等待xx秒后强制停止
    threadPool.setAwaitTerminationSeconds(60);
    //  线程名称前缀
    threadPool.setThreadNamePrefix(&quot;Rabbit-Async-&quot;);
    // 初始化线程
    threadPool.initialize();
    return threadPool;
  }

  @Override
  public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
    return null;
  }
}
</code></pre><h3 id="42-定义回调函数">4.2 定义回调函数</h3><pre><code class="language-java">
// 定义回调执行，消费者会监听一个队列，来消息时会调用这里的逻辑
DeliverCallback deliverCallback = (consumerTag, message) -&gt; {
//业务逻辑
};
</code></pre><h3 id="43-使用basicconsumer消费消息">4.3 使用basicConsumer消费消息</h3><pre><code class="language-java">
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

channel.basicConsume(queueName, true, deliverCallback, consumerTag -&gt; {});
</code></pre><h3 id="44-使用线程池启动basicconsumer">4.4 使用线程池启动basicConsumer</h3><pre><code class="language-java">package com.boo.rabbitmq.settlement.config;

import com.boo.rabbitmq.settlement.service.SettlementMessageService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * rabbit配置 spring启动时加载执行 orderMessageService.handleMessage()
 *
 * @author gaobo
 * @date 2022/03/18
 */
@Slf4j
@Configuration
public class RabbitConfig {
  @Autowired SettlementMessageService messageService;
    // spring初始化时会执行 @Configuration 注解类的 @Autowired注解的方法
  @Autowired
  public void startListenMessage() throws InterruptedException {
    messageService.handleMessage();
  }
}
</code></pre><footer><div class="post__tag-share"><div class="post__share"></div></div><div class="post__bio"><h3><a href="https://ct-choochoo.github.io/ch-publii-pages/authors/tiezhu/" title="铁柱">铁柱</a></h3></div></footer></div></div></article><div class="main__right"><div class="评论"><div class="comments-wrapper"><h5>评论区</h5><div id="cusdis_thread" data-host="https://cusdis.com" data-app-id="a6b326ad-a95f-4d7f-9076-1b06f4819430" data-page-id="7" data-page-url="https://ct-choochoo.github.io/ch-publii-pages/rabbitmq-erjian-dan-ren-shi-rabbitmq/" data-page-title="RabbitMQ_API" data-theme="light"></div><noscript>Please enable JS to use the comments form.</noscript><script type="text/javascript">var cusdis_element_to_check = document.getElementById('cusdis_thread');

				if ('IntersectionObserver' in window) {
					var iObserver = new IntersectionObserver(
						(entries, observer) => {
							entries.forEach(entry => {
								if (entry.intersectionRatio >= 0.1) {
									(function () {
										var d = document, s = d.createElement('script');
										s.defer = true;
										s.src = 'https://cusdis.com/js/cusdis.es.js';									
										(d.head || d.body).appendChild(s);
									})();
									observer.unobserve(entry.target);
								}
							});
						},
						{
							threshold: [0, 0.2, 0.5, 1]
						}
					);

					iObserver.observe(cusdis_element_to_check);
				} else {
					(function () {
						var d = document, s = d.createElement('script');
						s.defer = true;
						s.src = 'https://cusdis.com/js/cusdis.es.js';
						(d.head || d.body).appendChild(s);
					})();
				}</script><script type="text/javascript"></script></div></div><div class="banner banner--after-post"><script async defer="defer" src="https://cusdis.com/js/widget/lang/zh-cn.js"></script><script defer="defer" data-host="https://cusdis.com" data-app-id="{{id}}" src="https://cusdis.com/js/cusdis-count.umd.js"></script><div id="cusdis_thread" data-host="https://cusdis.com" data-app-id="a6b326ad-a95f-4d7f-9076-1b06f4819430" data-page-id="{{id}}" data-page-url="{{url}} " data-page-title="{{title}}"></div></div></div></main><footer class="footer"><div class="footer__copyright"><div style="text-align: left;"><a href="https://beian.miit.gov.cn/">陕ICP备2022014196号-1</a></div></div></footer></div></div><script defer="defer" src="https://ct-choochoo.github.io/ch-publii-pages/assets/js/scripts.min.js?v=27706a8fe221267c1834098c796f44c1"></script><script>var images = document.querySelectorAll('img[loading]');
   
           for (var i = 0; i < images.length; i++) {
               if (images[i].complete) {
                   images[i].classList.add('is-loaded');
               } else {
                   images[i].addEventListener('load', function () {
                       this.classList.add('is-loaded');
                   }, false);
               }
           }</script><script defer="defer" data-host="https://cusdis.com" data-app-id="a6b326ad-a95f-4d7f-9076-1b06f4819430" src="https://cusdis.com/js/cusdis-count.umd.js"></script><script src="https://ct-choochoo.github.io/ch-publii-pages/media/plugins/docSearch/docsearch.min.js"></script><script type="text/javascript">docsearch({
   				container: '#docsearch',
   				appId: '1940K55EKT',
   				indexName: 'blog_aow',
   				apiKey: '965ece45fd8bcfe08b8ce02572e77ea7',
   				debug: false
   			});</script></body></html>